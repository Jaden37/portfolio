(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{117:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return l})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return d}));var a=n(3),r=n(7),s=(n(0),n(136)),o={id:"configure-master-slave",title:"Configure a Master Slave Replication"},l={unversionedId:"PostgreSQL/configure-master-slave",id:"PostgreSQL/configure-master-slave",isDocsHomePage:!1,title:"Configure a Master Slave Replication",description:"Deux serveurs PostgreSQL sont n\xe9cessaire, un \xe9tant le Master, l'autre le Slave.",source:"@site/docs/PostgreSQL/configure-master-slave.md",slug:"/PostgreSQL/configure-master-slave",permalink:"/docs/PostgreSQL/configure-master-slave",editUrl:"https://github.com/j-peguet/portfolio/blob/master/docs/PostgreSQL/configure-master-slave.md",version:"current",lastUpdatedAt:1615911020,sidebar:"docs",previous:{title:"Install Longhorn",permalink:"/docs/Kubernetes-Advanced/install-longhorn"}},c=[{value:"If sudo is not install",id:"if-sudo-is-not-install",children:[]},{value:"Install PostgreSQL",id:"install-postgresql",children:[{value:"Configuration",id:"configuration",children:[]}]},{value:"Create test database",id:"create-test-database",children:[]},{value:"Install Bucardo Requirements",id:"install-bucardo-requirements",children:[]},{value:"Download and Install Bucardo",id:"download-and-install-bucardo",children:[]},{value:"Bucardo Configuration",id:"bucardo-configuration",children:[{value:"Initialisation",id:"initialisation",children:[]},{value:"S\xe9lection des bases",id:"s\xe9lection-des-bases",children:[]},{value:"S\xe9lection des tables",id:"s\xe9lection-des-tables",children:[]},{value:"Cr\xe9ation d&#39;une herdTable",id:"cr\xe9ation-dune-herdtable",children:[]},{value:"Cr\xe9ation d&#39;une synchronisation",id:"cr\xe9ation-dune-synchronisation",children:[]},{value:"Lancement de la synchronisation",id:"lancement-de-la-synchronisation",children:[]}]}],i={toc:c};function d(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(s.b)("wrapper",Object(a.a)({},i,n,{components:t,mdxType:"MDXLayout"}),Object(s.b)("p",null,"Deux serveurs PostgreSQL sont n\xe9cessaire, un \xe9tant le Master, l'autre le Slave."),Object(s.b)("p",null,"La base de donn\xe9es ",Object(s.b)("code",null,"test")," sera r\xe9pliqu\xe9e. "),Object(s.b)("p",null,"Les \xe9critures devront se faire ",Object(s.b)("strong",{parentName:"p"},"uniquement")," sur la base de donn\xe9es Master."),Object(s.b)("h3",{id:"if-sudo-is-not-install"},"If sudo is not install"),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"su\napt-get update\napt install sudo -y \n")),Object(s.b)("h2",{id:"install-postgresql"},"Install PostgreSQL"),Object(s.b)("p",null,"Installation de PostgreSQL sur chaque serveur.\nLa version choisie de PostgreSQL est 13.2."),Object(s.b)("p",null,"Plus d'infos ici: ",Object(s.b)("a",{parentName:"p",href:"https://www.postgresql.org/download/"},"https://www.postgresql.org/download/")),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"## If you don't have lsb_release command\nsudo apt install lsb-release -y\n\n# Create the file repository configuration:\nsudo sh -c 'echo \"deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" > /etc/apt/sources.list.d/pgdg.list'\n\n# Import the repository signing key:\nwget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -\n\n# Update the package lists:\nsudo apt-get update\n\n# Install the latest version of PostgreSQL.\n# If you want a specific version, use 'postgresql-12' or similar instead of 'postgresql':\nsudo apt-get -y install postgresql\n")),Object(s.b)("h3",{id:"configuration"},"Configuration"),Object(s.b)("p",null,"Modifier le fichier ",Object(s.b)("code",null,"/etc/postgresql/13/main/postgresql.conf")),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"# Uncomment the line and change 'localhost' to '*'\nlisten_addresses = '*'\n")),Object(s.b)("p",null,"Modifier le fichier ",Object(s.b)("code",null,"/etc/postgresql/13/main/pg_hba.conf")),Object(s.b)("div",{className:"admonition admonition-danger alert alert--danger"},Object(s.b)("div",{parentName:"div",className:"admonition-heading"},Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",{parentName:"h5",className:"admonition-icon"},Object(s.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},Object(s.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),"Ne pas faire ceci en PROD")),Object(s.b)("div",{parentName:"div",className:"admonition-content"},Object(s.b)("p",{parentName:"div"},"Le fichier ",Object(s.b)("code",null,"pg_hba.conf")," doit \xeatre configur\xe9 avec des acc\xe8s restreints et s\xe9curis\xe9s. "))),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"# Change this lines\nlocal   bucardo         bucardo                                 trust\nlocal   all             postgres                                trust\n# And add this lines\nhost    all             postgres        all                     trust\nhost    bucardo         bucardo         all                     trust\n\n# Reload PostgreSQL Service\nsudo service postgresql restart\n")),Object(s.b)("h2",{id:"create-test-database"},"Create test database"),Object(s.b)("p",null,"Cette base de donn\xe9es sera r\xe9pliqu\xe9 sur le deuxi\xe8me serveur PostgreSQL."),Object(s.b)("p",null,"Jouer le script de cr\xe9ation de base et de la table sur les deux serveurs PostgreSQL afin que leurs schema soient indentiques."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-sql"},'CREATE DATABASE test\n    WITH \n    OWNER = postgres\n    TEMPLATE = template0\n    ENCODING = \'UTF8\'\n    CONNECTION LIMIT = -1;\n\nCREATE EXTENSION IF NOT EXISTS "uuid-ossp";\n\nCREATE TABLE "user" (\n  "uid" uuid PRIMARY KEY DEFAULT (uuid_generate_v4()),\n  "email" varchar UNIQUE NOT NULL,\n  "password" varchar NOT NULL,\n  "username" varchar NOT NULL\n);\n\n-- Uniquement sur la base de donn\xe9es Master\nINSERT INTO public."user"(email, password, username)\n    VALUES (\'test@example.com\', \'StrongP@ssword\', \'John\');\n')),Object(s.b)("h2",{id:"install-bucardo-requirements"},"Install Bucardo Requirements"),Object(s.b)("p",null,"L'outil choisi pour cette r\xe9plication est ",Object(s.b)("a",{parentName:"p",href:"https://bucardo.org/Bucardo/installation/"},"Bucardo"),".\nL'utilitaire doit \xeatre install\xe9 ",Object(s.b)("strong",{parentName:"p"},"uniquement")," sur le serveur ",Object(s.b)("strong",{parentName:"p"},"Master"),"."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"sudo apt-get install libdbix-safe-perl -y\nsudo apt-get install libdbd-pg-perl -y\nsudo apt-get install postgresql-plperl-13 -y\n\n# For use 'make' command\nsudo apt-get install build-essential -y\n")),Object(s.b)("h2",{id:"download-and-install-bucardo"},"Download and Install Bucardo"),Object(s.b)("p",null,"T\xe9l\xe9chargement de l'outil"),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"mkdir bucardo\ncd bucardo\n# Download Bucardo\nwget https://bucardo.org/downloads/Bucardo-5.6.0.tar.gz\n# And it's signature\nwget https://bucardo.org/downloads/Bucardo-5.6.0.tar.gz.asc\n")),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"# Unzip the tar file\ntar xvfz Bucardo-5.6.0.tar.gz\ncd Bucardo-5.6.0/\nperl Makefile.PL\nsudo make install\n# The bucardo command os now available\nbucardo\n")),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},'# If you have an error with perl "perl: warning: Setting locale failed"\n# Uncomment the file "fr_FR.UTF-8 UTF-8"\nsudo nano /etc/locale.gen \nsudo locale-gen\n')),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"sudo mkdir -p /var/run/bucardo\nsudo mkdir -p /var/log/bucardo\n")),Object(s.b)("p",null,"Cr\xe9ation de la base de donn\xe9es et du role permettant de stocker les configurations de bucardo."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-sql"},"-- Create the user dans database \"bucardo\"\nCREATE ROLE bucardo WITH\n    LOGIN\n    SUPERUSER\n    CREATEDB\n    CREATEROLE\n    INHERIT\n    NOREPLICATION\n    CONNECTION LIMIT -1\n    PASSWORD 'bucardo';\n    \nCREATE DATABASE bucardo\n    WITH \n    OWNER = bucardo\n    TEMPLATE = template0\n    ENCODING = 'UTF8'\n    CONNECTION LIMIT = -1;\n")),Object(s.b)("h2",{id:"bucardo-configuration"},"Bucardo Configuration"),Object(s.b)("h3",{id:"initialisation"},"Initialisation"),Object(s.b)("p",null,"Initialisation de la base de donn\xe9es bucardo."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"bucardo install\n> Current connection settings:\n>    1. Host:           Localhost\n>    2. Port:           5432\n>    3. User:           bucardo\n>    4. Database:       bucardo\n>    5. PID directory:  /var/run/bucardo\n>    Enter a number to change it, P to proceed, or Q to quit: P\n>\n>    Attempting to create and populate the bucardo database and schema\n>    Database creation is complete\n\n# If you want to change one of these setting, tap the number and set the new value\n# If you don't have create a username, change it\n# Idem from database\n")),Object(s.b)("h3",{id:"s\xe9lection-des-bases"},"S\xe9lection des bases"),Object(s.b)("p",null,"S\xe9lection de la base de donn\xe9es source de la r\xe9plication (<...>_host)."),Object(s.b)("p",null,"Changer les variables dbname, port, host, user et password en fonction de vos configurations.\nList des varibles disponibles ",Object(s.b)("a",{parentName:"p",href:"https://bucardo.org/Bucardo/cli/add_database"},"ici"),"."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"bucardo add db test_host dbname=test port=5432 host=localhost user=bucardo password=bucardo\n")),Object(s.b)("p",null,"S\xe9lection de la base de donn\xe9es cible de la r\xe9plication (<...>_dest)."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"bucardo add db test_dest dbname=test port=5432 host=192.168.4.131 user=postgres password=postgres\n")),Object(s.b)("h3",{id:"s\xe9lection-des-tables"},"S\xe9lection des tables"),Object(s.b)("p",null,"Dans note exemple toutes les tables seront r\xe9pliqu\xe9es"),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"# Add tables\nbucardo add tables all db=test_host\n> New tables added: 1\n")),Object(s.b)("h3",{id:"cr\xe9ation-dune-herdtable"},"Cr\xe9ation d'une herdTable"),Object(s.b)("p",null,"La herdTable permet de regrouper les tables qui doivent \xeatre synchronis\xe9es."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},'bucardo add herd test_copying_herd all\n> Created relgroup "test_copying_herd"\n> The following tables or sequences are now part of the relgroup "test_copying_herd":\n>  public.user\n')),Object(s.b)("h3",{id:"cr\xe9ation-dune-synchronisation"},"Cr\xe9ation d'une synchronisation"),Object(s.b)("p",null,"La synchronisation permet de d\xe9finir, la tables source, la table cible et la herdTable qui doivent \xeatre li\xe9es."),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},'bucardo add sync sync_test relgroup=test_copying_herd dbs=test_host:source,test_dest:target onetimecopy=2\n> Added sync "sync_test"\n> Created a new dbgroup named "sync_test"\n')),Object(s.b)("h3",{id:"lancement-de-la-synchronisation"},"Lancement de la synchronisation"),Object(s.b)("pre",null,Object(s.b)("code",{parentName:"pre",className:"language-bash"},"sudo bucardo start\n> Checking for existing processes\n> Starting Bucardo\n\nsudo bucardo status\n> PID of Bucardo MCP: 6793\n> Name        State    Last good    Time    Last I/D    Last bad    Time  \n> ===========+========+============+=======+===========+===========+=======\n> sync_test | Good   | 14:13:44   | 18s   | 0/0       | none      |       \n")),Object(s.b)("p",null,"Et voil\xe0 !"),Object(s.b)("p",null,"Maintenant sur votre 2\xe8me BDD vous pouvez constater que les donn\xe9es ont \xe9t\xe9 r\xe9pliqu\xe9es. "),Object(s.b)("p",null,"Un autre tuto m'ayant aid\xe9 \xe0 r\xe9aliser celui ci.\nPour plus d'information: ",Object(s.b)("a",{parentName:"p",href:"https://installvirtual.com/how-to-install-bucardo-for-postgres-replication/"},"https://installvirtual.com/how-to-install-bucardo-for-postgres-replication/")))}d.isMDXComponent=!0},136:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return g}));var a=n(0),r=n.n(a);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=r.a.createContext({}),d=function(e){var t=r.a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=d(e.components);return r.a.createElement(i.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},p=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,s=e.originalType,o=e.parentName,i=c(e,["components","mdxType","originalType","parentName"]),u=d(n),p=a,g=u["".concat(o,".").concat(p)]||u[p]||b[p]||s;return n?r.a.createElement(g,l(l({ref:t},i),{},{components:n})):r.a.createElement(g,l({ref:t},i))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var s=n.length,o=new Array(s);o[0]=p;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var i=2;i<s;i++)o[i]=n[i];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);