(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{105:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return c})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return u}));var r=n(3),a=n(7),i=(n(0),n(136)),s={id:"install-traefik",title:"Install Traefik"},c={unversionedId:"Kubernetes-Advanced/install-traefik",id:"Kubernetes-Advanced/install-traefik",isDocsHomePage:!1,title:"Install Traefik",description:"Traefik est un reverse-proxy, il permet \xe0 vos utilisateurs d'avoir acc\xe8s \xe0 vos services internes.",source:"@site/docs/Kubernetes-Advanced/install-traefik.md",slug:"/Kubernetes-Advanced/install-traefik",permalink:"/docs/Kubernetes-Advanced/install-traefik",editUrl:"https://github.com/j-peguet/portfolio/blob/master/docs/Kubernetes-Advanced/install-traefik.md",version:"current",lastUpdatedAt:1618828164,sidebar:"docs",previous:{title:"Install MetalLB",permalink:"/docs/Kubernetes-Advanced/install-metallb"},next:{title:"Install Longhorn",permalink:"/docs/Kubernetes-Advanced/install-longhorn"}},l=[{value:"Installation de Traefik",id:"installation-de-traefik",children:[{value:"R\xe9cup\xe9ration des fichiers",id:"r\xe9cup\xe9ration-des-fichiers",children:[]},{value:"Modification de la configuration",id:"modification-de-la-configuration",children:[]},{value:"Lancement de l&#39;outil",id:"lancement-de-loutil",children:[]}]},{value:"Cr\xe9ation d&#39;IngressRoute personnalis\xe9e",id:"cr\xe9ation-dingressroute-personnalis\xe9e",children:[]},{value:"Sauvegarde du certificat SSL",id:"sauvegarde-du-certificat-ssl",children:[]}],o={toc:l};function u(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},o,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Traefik est un reverse-proxy, il permet \xe0 vos utilisateurs d'avoir acc\xe8s \xe0 vos services internes."),Object(i.b)("p",null,"Son principal avantage est qu'il est nativement compatible avec tous les types de cluster existant (Kubernetes, AWS, GCP, ...).\nCela permet de manager l'ensemble des services pr\xe9sent dans son infrastrucure simplement."),Object(i.b)("p",null,"Lien vers la documentation officelle: ",Object(i.b)("a",{parentName:"p",href:"https://doc.traefik.io/traefik/"},"https://doc.traefik.io/traefik/")),Object(i.b)("h2",{id:"installation-de-traefik"},"Installation de Traefik"),Object(i.b)("p",null,"Ces \xe9tapes sont \xe0 faire sur la machine Master uniquement."),Object(i.b)("p",null,"L'installation de traefik se passe en plusieurs \xe9tapes:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"#modification-de-la-configuration"},"Installation et Lancement de traefik")," (sans le stockage du certificat SSL)"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",{parentName:"li",href:"/docs/Kubernetes-Advanced/install-longhorn"},"Installation de longhorn")," pour stocker le certificat SSL"),Object(i.b)("li",{parentName:"ul"},"Enregistrement du certificat SSL")),Object(i.b)("h3",{id:"r\xe9cup\xe9ration-des-fichiers"},"R\xe9cup\xe9ration des fichiers"),Object(i.b)("p",null,"Nous allons cr\xe9er un dossier traefik qui stockera nos fichiers de configurations."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"mkdir traefik\ncd traefik\n")),Object(i.b)("p",null,"Copier les fichiers disponibles ici ",Object(i.b)("a",{parentName:"p",href:"https://gitlab.alexislegeay.fr/Witrem/kubernetes-tp/-/tree/master/Traefik"},"https://gitlab.alexislegeay.fr/Witrem/kubernetes-tp/-/tree/master/Traefik")," dans le dossier traefik."),Object(i.b)("h3",{id:"modification-de-la-configuration"},"Modification de la configuration"),Object(i.b)("p",null,"Nous allons modifier plusieurs fichiers de configuration."),Object(i.b)("h4",{id:"dans-le-fichier-configmapyaml"},"Dans le fichier ",Object(i.b)("code",null,"ConfigMap.yaml"),","),Object(i.b)("p",null,"Modifier les informations concernant votre certificat:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"storage = /cert (d\xe9fini dans longhorn)"),Object(i.b)("li",{parentName:"ul"},"changer le provider (ex: ovh, digitalocean, ...)")),Object(i.b)("p",null,"Modifier la partie ","[certificatesResolvers]"," et commenter toute la section ci-dessous, elle sera r\xe9activ\xe9e un fois le stockage distribu\xe9 install\xe9."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},'...\n# Certificates settings\n    [certificatesResolvers]\n      # Environment production\n     [certificatesResolvers.letsencrypt]\n        [certificatesResolvers.letsencrypt.acme]\n          email = "your.email@company.fr"\n          storage = "/certs/letsencrypt.json"\n          caServer = "https://acme-v02.api.letsencrypt.org/directory"\n          [certificatesResolvers.letsencrypt.acme.dnsChallenge]\n          # Replace by your provider (ovh, digitalocean, ...)\n            provider = "ovh"\n      # Environment staging\n      [certificatesResolvers.letsencrypt-staging]\n        [certificatesResolvers.letsencrypt-staging.acme]\n          email = "your.email@company.fr"\n          storage = "/certs/letsencrypt-staging.json"\n          caServer = "https://acme-staging-v02.api.letsencrypt.org/directory"\n          [certificatesResolvers.letsencrypt-staging.acme.dnsChallenge]\n          # Same here\n            provider = "ovh"\n...\n')),Object(i.b)("h4",{id:"dans-le-fichier-deploymentyaml"},"Dans le fichier ",Object(i.b)("code",null,"Deployment.yaml"),","),Object(i.b)("p",null,"Modifier les variables d'environnements par celles donn\xe9es par votre provider. Cela permettra de renouveler automatiquement le certificat SSL."),Object(i.b)("p",null,"La liste des providers support\xe9s par traefik est disponible ici: ",Object(i.b)("a",{parentName:"p",href:"https://doc.traefik.io/traefik/https/acme/#providers"},"doc.traefik.io/traefik/https/acme/#providers"),"."),Object(i.b)("p",null,"Commenter toute les parties li\xe9es au volume traefik-certs, qui permettra de stocker le certificat SSL."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"...\nspec:\n    serviceAccountName: traefik-ingress\n    containers:\n    - name: traefik\n    image: traefik:2.3\n    env:\n    - name: OVH_ENDPOINT\n        value: <your_endpoint>\n    - name: OVH_APPLICATION_KEY\n        value: <your_key>\n    - name: OVH_APPLICATION_SECRET\n        value: <your_app_key>\n    - name: OVH_CONSUMER_KEY\n        value: <your_consumer_key>\n    args:\n    - --configFile=/config/traefik.toml\n    volumeMounts:\n    - name: traefik-config\n        mountPath: /config/\n    - name: traefik-custom\n        mountPath: /custom/\n    # - name: traefik-certs\n        # mountPath: /certs/\n    ports:\n    - name: http\n        containerPort: 80\n    - name: https\n        containerPort: 443\n    - name: dashboard\n        containerPort: 8080\n    volumes:\n    - name: traefik-config\n    configMap:\n        name: traefik-config\n    - name: traefik-custom\n    configMap:\n        name: traefik-custom\n    # - name: traefik-certs\n    # persistentVolumeClaim:\n        # claimName: traefik-certs\n...\n")),Object(i.b)("h4",{id:"dans-le-fichier-serviceyaml"},"Dans le fichier ",Object(i.b)("code",null,"Service.yaml"),","),Object(i.b)("p",null,"V\xe9rifier que les services aient le type LoadBalancer (et non NodePort)."),Object(i.b)("h3",{id:"lancement-de-loutil"},"Lancement de l'outil"),Object(i.b)("p",null,"Maintenant que la configuration est termin\xe9e nous pouvons appliquer tous les fichiers de configuration pr\xe9sent dans le dossier."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"cd ..\nsudo kubectl apply -f traefik/\n")),Object(i.b)("h2",{id:"cr\xe9ation-dingressroute-personnalis\xe9e"},"Cr\xe9ation d'IngressRoute personnalis\xe9e"),Object(i.b)("p",null,"Les IngressRoute permettent \xe0 vos services d'\xeatre accessibles depuis l'exterieur de votre r\xe9seau en fonction de r\xe8gles d\xe9finies (g\xe9n\xe9ralement le nom de domaine)."),Object(i.b)("p",null,"Une seule IngressRoute doit exister par service, mais celle-ci peut comporter plusieurs r\xe8gles \xe0 l'int\xe9rieur."),Object(i.b)("p",null,"Si votre IngressRoute dispose d'un certificat SSL, d\xe9commenter les parties dans ",Object(i.b)("code",null,"spec")," correspondantes."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: <your_service>-ingress\n  namespace: <your_service_namespace>\nspec:\n  entrypoints:\n  - http\n  # - https\n  routes:\n  - match: Host(`custom.domain.com`)\n    kind: Rule\n    services:\n    - name: <your_service>\n      port: 3000\n  # tls:\n    # certResolver: letsencrypt\n")),Object(i.b)("h2",{id:"sauvegarde-du-certificat-ssl"},"Sauvegarde du certificat SSL"),Object(i.b)("p",null,"Si vous disposez d'un certificat, il est important de le stocker dans un stockage distribu\xe9."),Object(i.b)("p",null,"Une fois longhorn (ou autre syst\xe8me de stockage) install\xe9, cr\xe9er un fichier de pvc."),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"sudo nano PVC-traefik-certs.yaml\n")),Object(i.b)("p",null,"Ne pas oublier de changer le storageClassName en fonction de votre syst\xe8me de stockage (ex: longhorn, rook-cephfs, ...)"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: traefik-certs\n  namespace: kube-system\n  labels:\n    app: traefik-ingress\nspec:\n  accessModes:\n  - ReadWriteMany\n  storageClassName: longhorn\n  resources:\n    requests:\n      storage: 32Mi\n")),Object(i.b)("p",null,"D\xe9commenter dans le fichier ConfigMap.yaml la partie ","[certificatesResolvers]"),Object(i.b)("p",null,"D\xe9commenter dans le fichier Deployment.yml toute les parties li\xe9es au volume traefik-certs dans volumeMounts et volumes."),Object(i.b)("p",null,"F\xe9liciations \ud83c\udf89 !! L'installation de Traefik est finie (c'est l'une des \xe9tapes les plus compliqu\xe9s, vous avez bien progress\xe9)."))}u.isMDXComponent=!0},136:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return f}));var r=n(0),a=n.n(r);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var o=a.a.createContext({}),u=function(e){var t=a.a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},p=function(e){var t=u(e.components);return a.a.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,o=l(e,["components","mdxType","originalType","parentName"]),p=u(n),m=r,f=p["".concat(s,".").concat(m)]||p[m]||d[m]||i;return n?a.a.createElement(f,c(c({ref:t},o),{},{components:n})):a.a.createElement(f,c({ref:t},o))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=m;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:r,s[1]=c;for(var o=2;o<i;o++)s[o]=n[o];return a.a.createElement.apply(null,s)}return a.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);